-- ServerScrptService->FishingServer
local DataStoreService = game:GetService("DataStoreService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")

local PlayerData = DataStoreService:GetDataStore("FishingGameData_V3") -- Bumped version to reset bad data
local FishDB = require(ReplicatedStorage:WaitForChild("FishDatabase"))

-- 1. ROBUST EVENT SETUP (Fixes the Infinite Yield)
local CatchEvent = ReplicatedStorage:FindFirstChild("CatchFish")
if not CatchEvent then
	CatchEvent = Instance.new("RemoteEvent")
	CatchEvent.Name = "CatchFish"
	CatchEvent.Parent = ReplicatedStorage
	print("Server: Created CatchFish event automatically.")
end

-- Temporary table to remember what fish a player currently has on the hook
local activeHooks = {}

-- 2. SETUP PLAYER DATA
Players.PlayerAdded:Connect(function(player)
	-- A. Create Leaderstats
	local leaderstats = Instance.new("Folder")
	leaderstats.Name = "leaderstats"
	leaderstats.Parent = player

	local cash = Instance.new("IntValue")
	cash.Name = "Cash"
	cash.Parent = leaderstats

	-- B. Create Inventory (Fixes the Client Crash)
	local inventory = Instance.new("Folder")
	inventory.Name = "FishInventory"
	inventory.Parent = player

	-- C. Load Data
	local success, data = pcall(function() return PlayerData:GetAsync(player.UserId) end)

	if success and data then
		cash.Value = data.Cash or 0

		-- Load Caught Fish
		if data.Inventory then
			for _, fishName in pairs(data.Inventory) do
				local fishTag = Instance.new("StringValue")
				fishTag.Name = fishName
				fishTag.Parent = inventory
			end
		end

		-- Load Rod (The "Keep on Death" Fix)
		if data.HasRod then
			local rod = game.ServerStorage:FindFirstChild("FlimsyRod")
			if rod then 
				-- Give to Backpack (Current Life)
				rod:Clone().Parent = player.Backpack
				-- Give to StarterGear (Future Lives/Resets)
				rod:Clone().Parent = player.StarterGear
			end
		end
	else
		print("New player or data load failed.")
	end
end)

-- 3. SAVE DATA
Players.PlayerRemoving:Connect(function(player)
	activeHooks[player] = nil

	local inv = {}
	if player:FindFirstChild("FishInventory") then
		for _, item in pairs(player.FishInventory:GetChildren()) do
			table.insert(inv, item.Name)
		end
	end

	-- Check if they have the rod in Backpack OR Character (equipped)
	local hasRod = false
	if player.Backpack:FindFirstChild("FlimsyRod") or (player.Character and player.Character:FindFirstChild("FlimsyRod")) then
		hasRod = true
	end

	pcall(function()
		PlayerData:SetAsync(player.UserId, {
			Cash = player.leaderstats.Cash.Value, 
			Inventory = inv, 
			HasRod = hasRod
		})
	end)
end)

-- 4. HANDLE FISHING LOGIC
CatchEvent.OnServerEvent:Connect(function(player, action, data)

	-- A. Requesting a Bite
	if action == "RequestBite" then
		local zoneName = data
		local pickedFish = "Old Boot"

		-- 1. CHECK FOR ADMIN OVERRIDE (New Code)
		local forced = player:GetAttribute("ForcedCatch")
		if forced and forced ~= "" then
			print("âš¡ ADMIN FORCE CATCH: " .. forced)
			pickedFish = forced
			-- Clear it so it only happens once (Optional: Remove this line to keep forcing it forever)
			player:SetAttribute("ForcedCatch", nil) 

		else
			-- 2. NORMAL LOGIC (Existing Code)
			local potentialFish = {}
			local totalWeight = 0

			print("Server: " .. player.Name .. " fishing in zone: " .. tostring(zoneName))

			-- Filter fish by Zone
			for name, info in pairs(FishDB.Fish) do
				if info.Zone == zoneName or info.Zone == "Any" then
					table.insert(potentialFish, {Name = name, Rarity = info.Rarity})
					totalWeight = totalWeight + info.Rarity
				end
			end

			-- Failsafe
			if #potentialFish == 0 then
				table.insert(potentialFish, {Name = "Old Boot", Rarity = 100})
				totalWeight = 100
			end

			-- Weighted Random Choice
			local rng = math.random(1, totalWeight)
			local currentWeight = 0

			for _, fish in pairs(potentialFish) do
				currentWeight = currentWeight + fish.Rarity
				if rng <= currentWeight then
					pickedFish = fish.Name
					break
				end
			end
		end

		-- Save hook & Tell Client
		activeHooks[player] = pickedFish
		CatchEvent:FireClient(player, "Hooked", pickedFish)

		-- B. Claiming a Catch
	elseif action == "ClaimCatch" then
		local hookedFish = activeHooks[player]

		if hookedFish then
			local fishData = FishDB.Fish[hookedFish]
			if fishData then
				-- Add to Inventory
				local tag = Instance.new("StringValue")
				tag.Name = hookedFish
				tag.Parent = player.FishInventory

				print(player.Name .. " successfully caught " .. hookedFish)

				-- Tell client to show UI
				CatchEvent:FireClient(player, "Reward", hookedFish)
			end
		end
		activeHooks[player] = nil
	end
end)
